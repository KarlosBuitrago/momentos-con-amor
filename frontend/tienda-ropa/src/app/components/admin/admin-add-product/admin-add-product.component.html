<div class="admin-add-product">
  <div class="header">
    <h2>Registrar nuevo producto</h2>
    <p>Completa los campos para cargar un mu√±eco o material a la tienda. Los campos marcados con * son obligatorios.</p>
    <small class="backend-hint">Guardando en: {{ backendEndpoint }}</small>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
    <!-- INFORMACI√ìN GENERAL -->
    <section class="form-card">
      <h3>Informaci√≥n general</h3>
      <div class="field-grid">
        <div class="field" [class.invalid]="isInvalid('name')">
          <label for="name">Nombre *</label>
          <input id="name" type="text" formControlName="name" autocomplete="off" placeholder="Ej. Unicornio de Sue√±os">
          <small *ngIf="isInvalid('name')">Ingresa un nombre para el producto.</small>
        </div>

        <div class="field" [class.invalid]="isInvalid('category')">
          <label for="category">Categor√≠a *</label>
          <select id="category" formControlName="category">
            <option *ngFor="let option of categoryOptions" [value]="option.value">{{ option.label }}</option>
          </select>
        </div>

        <div class="field" *ngIf="isDoll" [class.invalid]="isInvalid('targetAudience')">
          <label for="targetAudience">P√∫blico objetivo *</label>
          <select id="targetAudience" formControlName="targetAudience">
            <option *ngFor="let audience of targetAudienceOptions" [value]="audience">{{ audience }}</option>
          </select>
          <small *ngIf="isInvalid('targetAudience')">Selecciona el p√∫blico objetivo.</small>
        </div>

        <div class="field" *ngIf="isDoll" [class.invalid]="isInvalid('dollGender')">
          <label for="dollGender">G√©nero del mu√±eco</label>
          <select id="dollGender" formControlName="dollGender">
            <option *ngFor="let gender of genderOptions" [value]="gender">{{ gender }}</option>
          </select>
        </div>

        <div class="field" [class.invalid]="isInvalid('price')">
          <label for="price">Precio (COP) *</label>
          <input id="price" type="number" min="0" step="1000" formControlName="price" placeholder="68000">
          <small *ngIf="isInvalid('price')">Define el precio de venta.</small>
        </div>

        <div class="field full" [class.invalid]="isInvalid('description')">
          <label for="description">Descripci√≥n *</label>
          <textarea id="description" rows="3" formControlName="description" placeholder="Unicornio tejido con crin multicolor y detalles brillantes. Incluye base estable y bolsa protectora."></textarea>
          <small *ngIf="isInvalid('description')">Incluye una descripci√≥n entre 10 y 700 caracteres.</small>
        </div>
      </div>
    </section>

    <!-- IM√ÅGENES -->
    <section class="form-card">
      <h3>Im√°genes</h3>
      <div class="field-grid">
        <div class="field" [class.invalid]="isInvalid('imageUrl')">
          <label for="imageUrl">URL de la imagen principal *</label>
          <div class="input-with-file">
            <input id="imageUrl" type="text" formControlName="imageUrl" placeholder="assets/images/imagen 5.jpg o selecciona un archivo">
            <input #mainImageFile type="file" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" (change)="onMainImageFileSelected($event)" style="display: none">
            <button type="button" class="btn-file" (click)="mainImageFile.click()" title="Seleccionar imagen desde el equipo">üìÅ</button>
            <button type="button" class="btn-clear" *ngIf="selectedMainImage" (click)="clearMainImage(mainImageFile)" title="Limpiar imagen seleccionada">üóëÔ∏è</button>
          </div>
          <small *ngIf="isInvalid('imageUrl')">Proporciona la ruta, URL o selecciona una imagen desde tu equipo.</small>
        </div>

        <div class="image-preview">
          <span>Vista previa</span>
          <img [src]="form.get('imageUrl')?.value || defaultImage" alt="Previsualizaci√≥n del producto" loading="lazy">
        </div>
      </div>

      <h4>Galer√≠a de im√°genes adicionales</h4>
      <p class="helper-text">Agrega m√°s im√°genes para mostrar diferentes √°ngulos del producto.</p>
      <div formArrayName="imageGallery" class="array-wrapper">
        <div class="array-row" *ngFor="let control of imageGallery.controls; let i = index; trackBy: trackByIndex">
          <div class="input-with-file">
            <input [formControlName]="i" type="text" placeholder="URL o selecciona un archivo">
            <input #galleryImageFile type="file" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" (change)="onGalleryImageFileSelected(i, $event)" style="display: none">
            <button type="button" class="btn-file" (click)="galleryImageFile.click()" title="Seleccionar imagen">üìÅ</button>
            <button type="button" class="btn-clear" *ngIf="selectedGalleryImages.has(i)" (click)="clearGalleryImage(i, galleryImageFile)" title="Limpiar imagen">üóëÔ∏è</button>
          </div>
          <button type="button" (click)="removeImageGalleryField(i)">Eliminar</button>
        </div>
      </div>
      <button type="button" class="btn-secondary" (click)="addImageGalleryField()">Agregar imagen</button>
    </section>

    <!-- MATERIALES -->
    <section class="form-card" *ngIf="isDoll">
      <h3>Materiales *</h3>
      <p class="helper-text">Describe con qu√© materiales est√° elaborado el producto.</p>
      <div formArrayName="madeWith" class="array-wrapper">
        <div class="array-row" *ngFor="let control of madeWith.controls; let i = index; trackBy: trackByIndex" [class.invalid]="isArrayControlInvalid('madeWith', i)">
          <input [formControlName]="i" type="text" placeholder="Ej. Hilo hipoalerg√©nico">
          <button type="button" (click)="removeMadeWithField(i)" [disabled]="madeWith.length === 1">Eliminar</button>
        </div>
      </div>
      <button type="button" class="btn-secondary" (click)="addMadeWithField()">Agregar material</button>

      <h4 style="margin-top: 20px;">Selector Inteligente de Materiales</h4>
      <p class="helper-text">Selecciona materiales del cat√°logo existente para reutilizarlos.</p>
      <app-material-selector
        [selectedMaterialIds]="selectedMaterialIds"
        (materialsChanged)="onMaterialsChanged($event)">
      </app-material-selector>
    </section>

    <!-- PERSONALIZACIONES -->
    <section class="form-card" *ngIf="isDoll">
      <h3>Opciones de personalizaci√≥n</h3>
      <div class="toggle-row">
        <label>
          <input type="checkbox" formControlName="allowPersonalization">
          Permitir personalizaciones
        </label>
      </div>

      <h4>Personalizaciones disponibles</h4>
      <p class="helper-text">Define las opciones de personalizaci√≥n que el cliente puede agregar (bordados, accesorios, empaques especiales, etc.).</p>
      <div formArrayName="customizations" class="customizations-wrapper">
        <div class="customization-card" *ngFor="let customGroup of customizations.controls; let i = index; trackBy: trackByIndex" [formGroupName]="i">
          <div class="customization-fields">
            <div class="field">
              <label>Nombre de la personalizaci√≥n *</label>
              <input type="text" formControlName="label" placeholder="Ej. Luces led interiores">
            </div>
            <div class="field">
              <label>Precio adicional (COP)</label>
              <input type="number" min="0" step="500" formControlName="price" placeholder="9000">
            </div>
            <div class="field checkbox-field">
              <label>
                <input type="checkbox" formControlName="defaultSelected">
                Seleccionada por defecto
              </label>
            </div>
          </div>
          <button type="button" class="btn-remove" (click)="removeCustomizationField(i)">Eliminar</button>
        </div>
      </div>
      <button type="button" class="btn-secondary" (click)="addCustomizationField()">Agregar personalizaci√≥n</button>

      <h4 style="margin-top: 20px;">Selector Inteligente de Personalizaciones</h4>
      <p class="helper-text">Selecciona personalizaciones del cat√°logo existente para reutilizarlas.</p>
      <app-customization-selector
        [selectedCustomizationIds]="selectedCustomizationIds"
        [productType]="'doll'"
        (customizationsChanged)="onCustomizationsChanged($event)">
      </app-customization-selector>
    </section>

    <!-- KIT -->
    <section class="form-card" *ngIf="isDoll">
      <h3>Kit para armar</h3>
      <div class="toggle-row">
        <label>
          <input type="checkbox" formControlName="isKit">
          Este mu√±eco se vende como kit para armar
        </label>
      </div>

      <div class="kit-card" *ngIf="showKitSection" formArrayName="kitIncludes">
        <h4>Contenido del kit *</h4>
        <p class="helper-text">Enumera los elementos que el cliente recibir√° para armar el mu√±eco.</p>
        <div class="array-wrapper">
          <div class="array-row" *ngFor="let control of kitIncludes.controls; let i = index; trackBy: trackByIndex" [class.invalid]="isArrayControlInvalid('kitIncludes', i)">
            <input [formControlName]="i" type="text" placeholder="Ej. Ganchillo 3.5mm">
            <button type="button" (click)="removeKitIncludeField(i)">Eliminar</button>
          </div>
        </div>
        <button type="button" class="btn-secondary" (click)="addKitIncludeField()">Agregar elemento</button>
      </div>
    </section>

    <!-- ETIQUETAS -->
    <section class="form-card">
      <h3>Etiquetas (Tags)</h3>
      <p class="helper-text">Agrega palabras clave para facilitar la b√∫squeda del producto (ej. unicornio, fantas√≠a, luces).</p>
      <div formArrayName="tags" class="array-wrapper">
        <div class="array-row" *ngFor="let control of tags.controls; let i = index; trackBy: trackByIndex">
          <input [formControlName]="i" type="text" placeholder="Ej. unicornio" maxlength="50">
          <button type="button" (click)="removeTagField(i)">Eliminar</button>
        </div>
      </div>
      <button type="button" class="btn-secondary" (click)="addTagField()">Agregar etiqueta</button>

      <h4 style="margin-top: 20px;">Selector Inteligente de Tags</h4>
      <p class="helper-text">Selecciona tags del cat√°logo existente para organizar mejor tus productos.</p>
      <app-tag-selector
        [selectedTagIds]="selectedTagIds"
        (tagsChanged)="onTagsChanged($event)">
      </app-tag-selector>
    </section>

    <!-- INVENTARIO Y PRODUCCI√ìN -->
    <section class="form-card">
      <h3>Inventario y producci√≥n</h3>
      <div class="field-grid">
        <div class="field" [class.invalid]="isInvalid('stock')">
          <label for="stock">Stock disponible *</label>
          <input id="stock" type="number" min="0" formControlName="stock" placeholder="4">
          <small *ngIf="isInvalid('stock')">Indica las unidades disponibles.</small>
        </div>

        <div class="field">
          <label for="productionTimeDays">Tiempo estimado de producci√≥n (d√≠as)</label>
          <input id="productionTimeDays" type="number" min="1" formControlName="productionTimeDays" placeholder="10">
          <small>Tiempo que toma producir el producto bajo pedido.</small>
        </div>
      </div>

      <div class="toggle-row">
        <label>
          <input type="checkbox" formControlName="isAvailable">
          Producto disponible para la venta
        </label>
        <small class="helper-text">Si est√° desmarcado, se mostrar√° como "Producci√≥n temporalmente agotada"</small>
      </div>
    </section>

    <!-- ACCIONES -->
    <div class="form-actions">
      <button type="submit" class="btn-primary" [disabled]="form.invalid || isSubmitting">
        {{ isSubmitting ? 'Guardando‚Ä¶' : 'Guardar producto' }}
      </button>
      <button type="button" class="btn-ghost" (click)="resetForm()" [disabled]="isSubmitting">Limpiar</button>
    </div>
  </form>

  <div class="status" *ngIf="statusMessage" [class.success]="statusType === 'success'" [class.error]="statusType === 'error'">
    {{ statusMessage }}
  </div>
</div>
