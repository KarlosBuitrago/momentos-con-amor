<div class="modal-backdrop" *ngIf="isOpen" (click)="onBackdropClick($event)">
  <div class="modal-content" *ngIf="product">
    <button class="modal-close" (click)="closeModal()">&times;</button>

    <div class="modal-body">
      <div class="modal-image">
        <img [src]="product.imageUrl || 'assets/images/default-doll.svg'" [alt]="product.name">

        <div class="image-gallery" *ngIf="product.imageGallery && product.imageGallery.length > 1">
          <img *ngFor="let img of product.imageGallery"
               [src]="img"
               [alt]="product.name"
               class="gallery-thumb">
        </div>
      </div>

      <div class="modal-info">
        <h2>{{ product.name }}</h2>
        <p class="product-category">{{ product.category }} | {{ product.targetAudience }}</p>
        <p class="product-price">{{ product.price | currency:'COP':'symbol-narrow':'1.0-0' }}</p>

        <div class="product-description">
          <h3>Descripci√≥n</h3>
          <p>{{ product.description }}</p>
        </div>

        <div class="product-details" *ngIf="product.materials && product.materials.length">
          <h3>Materiales</h3>
          <ul>
            <li *ngFor="let material of product.materials">{{ material }}</li>
          </ul>
        </div>

        <div class="product-details" *ngIf="product.includedMaterials && product.includedMaterials.length">
          <h3>Incluye</h3>
          <ul>
            <li *ngFor="let item of product.includedMaterials">{{ item }}</li>
          </ul>
        </div>

        <div class="product-meta">
          <span *ngIf="product.difficulty">
            <strong>Dificultad:</strong> {{ product.difficulty }}
          </span>
          <span *ngIf="product.productionTimeDays">
            <strong>Tiempo de producci√≥n:</strong> {{ product.productionTimeDays }} d√≠a{{ product.productionTimeDays === 1 ? '' : 's' }}
          </span>
          <span *ngIf="product.stock !== undefined">
            <strong>Stock:</strong> {{ product.stock }} unidades
          </span>
        </div>

        <div class="product-tags" *ngIf="product.tags && product.tags.length">
          <span class="tag" *ngFor="let tag of product.tags">#{{ tag }}</span>
        </div>

        <!-- PERSONALIZACIONES (Solo para Mu√±ecos) -->
        <div class="customizations-section" *ngIf="isDoll && availableCustomizations.length > 0">
          <h3>Personaliza tu mu√±eco</h3>
          <p class="section-subtitle">Selecciona las opciones que desees agregar</p>

          <div class="customizations-loading" *ngIf="isLoadingCustomizations">
            Cargando opciones...
          </div>

          <div class="customizations-list" *ngIf="!isLoadingCustomizations">
            <label class="customization-item" *ngFor="let custom of availableCustomizations">
              <input
                type="checkbox"
                [checked]="isCustomizationSelected(custom.id!)"
                (change)="toggleCustomization(custom.id!)">
              <div class="customization-info">
                <span class="customization-name">{{ custom.name }}</span>
                <span class="customization-description" *ngIf="custom.description">
                  {{ custom.description }}
                </span>
              </div>
              <span class="customization-price">
                +{{ custom.price | currency:'COP':'symbol-narrow':'1.0-0' }}
              </span>
            </label>
          </div>

          <div class="customizations-summary" *ngIf="selectedCustomizations.length > 0">
            <p><strong>Personalizaciones seleccionadas:</strong></p>
            <ul>
              <li *ngFor="let custom of selectedCustomizations">
                {{ custom.name }} - {{ custom.price | currency:'COP':'symbol-narrow':'1.0-0' }}
              </li>
            </ul>
            <p class="customizations-total">
              <strong>Total personalizaciones:</strong>
              {{ customizationsTotal | currency:'COP':'symbol-narrow':'1.0-0' }}
            </p>
          </div>
        </div>

        <!-- INFORMACI√ìN ADICIONAL PARA MATERIALES -->
        <div class="material-info" *ngIf="isMaterial">
          <div class="info-box">
            <h4>üì¶ Informaci√≥n del Material</h4>
            <p>Este material est√° disponible para entrega inmediata.</p>
            <p *ngIf="product.stock > 10" class="stock-high">‚úì Stock disponible</p>
            <p *ngIf="product.stock <= 10 && product.stock > 0" class="stock-low">
              ‚ö†Ô∏è √öltimas {{ product.stock }} unidades
            </p>
          </div>
        </div>

        <!-- INFORMACI√ìN ADICIONAL PARA CURSOS -->
        <div class="course-info" *ngIf="isCourse">
          <div class="info-box">
            <h4>üéì Informaci√≥n del Curso</h4>
            <p *ngIf="product.isCourse">
              <strong>Modalidad:</strong> {{ product.stock > 100 ? 'Online (acceso ilimitado)' : 'Presencial (cupos limitados)' }}
            </p>
            <p *ngIf="product.stock <= 100">
              <strong>Cupos disponibles:</strong> {{ product.stock }}
            </p>
            <p *ngIf="product.productionTimeDays === 0">
              <strong>Acceso:</strong> Inmediato despu√©s de la compra
            </p>
          </div>
        </div>

        <!-- CANTIDAD Y PRECIO TOTAL -->
        <div class="quantity-section">
          <h3>Cantidad</h3>
          <div class="quantity-controls">
            <button class="btn-quantity" (click)="decrementQuantity()" [disabled]="quantity <= 1">
              -
            </button>
            <input
              type="number"
              [(ngModel)]="quantity"
              min="1"
              [max]="product.stock"
              class="quantity-input"
              readonly>
            <button class="btn-quantity" (click)="incrementQuantity()" [disabled]="quantity >= product.stock">
              +
            </button>
          </div>
          <p class="stock-info">Stock disponible: {{ product.stock }} unidades</p>
        </div>

        <!-- RESUMEN DE PRECIO -->
        <div class="price-summary">
          <div class="price-row">
            <span>Precio base:</span>
            <span>{{ product.price | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          </div>
          <div class="price-row" *ngIf="customizationsTotal > 0">
            <span>Personalizaciones:</span>
            <span>{{ customizationsTotal | currency:'COP':'symbol-narrow':'1.0-0' }}</span>
          </div>
          <div class="price-row" *ngIf="quantity > 1">
            <span>Cantidad:</span>
            <span>√ó {{ quantity }}</span>
          </div>
          <div class="price-row price-total">
            <span><strong>Total:</strong></span>
            <span><strong>{{ totalPrice | currency:'COP':'symbol-narrow':'1.0-0' }}</strong></span>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-add-cart" (click)="onAddToCart()" [disabled]="product.stock === 0">
            {{ product.stock === 0 ? 'Sin stock' : 'A√±adir al carrito' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
